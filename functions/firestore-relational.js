(function(a,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("firebase-admin/firestore"),require("firebase-functions/v2/https")):typeof define=="function"&&define.amd?define(["exports","firebase-admin/firestore","firebase-functions/v2/https"],l):(a=typeof globalThis<"u"?globalThis:a||self,l(a.FirestoreRelational={},a.firebaseadminfirestore,a.firebasefunctionsv2https))})(this,function(a,l,j){"use strict";const O="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");function F(t){if(t===0)return"0";const n=[];for(;t>0;)n.push(O[t%62]),t=Math.floor(t/62);return n.join("")}function w(t,n=0){const i=typeof t=="string"?t:typeof t=="object"?JSON.stringify(t):`${typeof t}(${String(t)})`;let e=3735928559^n,o=1103547991^n;for(let h=0,u;h<i.length;h++)u=i.charCodeAt(h),e=Math.imul(e^u,2246822519),o=Math.imul(o^u,3266489917);e^=Math.imul(e^o>>>15,1935289751),o^=Math.imul(o^e>>>15,3405138345),e^=o>>>16,o^=e>>>16;const f=2097152*(o>>>0)+(e>>>11);return F(f)}function M(t){return{collections:t}}function p(t,n={}){const i={};for(const e in n){const o=n[e];i[e]=o}return{path:t,relations:i,hash:w({path:t,relations:i})}}function R(t){return{type:"has-many",...t,collection:typeof t.collection=="string"?p(t.collection):t.collection}}function T(t){return{type:"has-one",...t,collection:typeof t.collection=="string"?p(t.collection):t.collection}}console.log("gff v1");function D(t){return{migrate:j.onCall({timeoutSeconds:540},async n=>{console.log("v1");const{collectionPath:i}=n.data,e=t.collections.find(({path:c})=>c===i);if(!e){const c=t.collections.map(({path:s})=>s);throw new Error(`No schema found for collection with path ${i}. Schemas found for ${c.join(",")}`)}const o=w(e),{path:f,relations:h}=e,u=Object.entries(h),d=await l.getFirestore().collection(f).get();for(const c of d.docs){const s={id:c.id,...c.data()};if(s.__firestoreRelationalSchemaHash===o){console.log("skipping",s);continue}console.log("doc",s,"does not have current hash",o);const r=await b(`${i}/${c.id}`,s,u),m=JSON.stringify(s),g=JSON.stringify({...s,...r}),$=JSON.stringify(r);g===m||$==="{}"||(console.log("diff!",{data:s,relationData:r,jsonRelational:$}),await l.getFirestore().doc(`${i}/${c.id}`).update(r))}return{message:"This is where we would migrate",collectionPath:i}})}}async function b(t,n,i,e){const o={};for(const[f,{type:h,localKey:u,foreignKey:d,collection:c}]of i){const s=n[u];if(s==null){console.warn(`Tried to set up relation between document ${t} and ${c.path} but the ${u} field was not defined.`);continue}const y=await l.getFirestore().collection(c.path).where(d==="id"?l.FieldPath.documentId():d,"==",s).get();if(h==="has-many"){const r=[];for(const m of y.docs){const g=await S(m,c);r.push(g)}o[f]=r}else if(h==="has-one"){const[r]=y.docs;if(!r){console.warn(`Tried to set up relation between document ${t} and ${c.path} but there are no documents with ${d} == ${JSON.stringify(s)}`);continue}o[f]=await S(r,c)}}return o}async function S(t,n,i){const e=Object.keys(n.relations).length>0,o={id:t.id,...t.data()};if(!e)return o;const f=await b(`${n.path}/${t.id}`,o,Object.entries(n.relations));return Object.assign(o,f),o}a.collection=p,a.getFirebaseFunctions=D,a.hasMany=R,a.hasOne=T,a.project=M,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliLnVtZC5qcyIsInNvdXJjZXMiOlsiLi4vbGliL2hlbHBlcnMvYmFzZTYyLnRzIiwiLi4vbGliL2hlbHBlcnMvaGFzaC50cyIsIi4uL2xpYi9yZWxhdGlvbnMudHMiLCIuLi9saWIvZ2V0RmlyZWJhc2VGdW5jdGlvbnMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQ0hBUlNFVCA9XG4gIFwiMDEyMzQ1Njc4OWFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVpcIi5zcGxpdChcbiAgICBcIlwiXG4gIClcblxuZXhwb3J0IGZ1bmN0aW9uIHRvQmFzZTYyKGludGVnZXI6IG51bWJlcikge1xuICBpZiAoaW50ZWdlciA9PT0gMCkge1xuICAgIHJldHVybiBcIjBcIlxuICB9XG5cbiAgY29uc3QgY2hhcnMgPSBbXVxuICB3aGlsZSAoaW50ZWdlciA+IDApIHtcbiAgICBjaGFycy5wdXNoKENIQVJTRVRbaW50ZWdlciAlIDYyXSlcbiAgICBpbnRlZ2VyID0gTWF0aC5mbG9vcihpbnRlZ2VyIC8gNjIpXG4gIH1cblxuICByZXR1cm4gY2hhcnMuam9pbihcIlwiKVxufVxuIiwiaW1wb3J0IHsgdG9CYXNlNjIgfSBmcm9tIFwiLi9iYXNlNjJcIlxuXG4vKipcbiAqIEFkYXB0ZWQgZnJvbVxuICogaHR0cHM6Ly9naXRodWIuY29tL2JyeWMvY29kZS9ibG9iL21hc3Rlci9qc2hhc2gvZXhwZXJpbWVudGFsL2N5cmI1My5qc1xuICpcbiAqIENvcHlyaWdodCAoYykgMjAyMyBicnljXG4gKlxuICogTGljZW5zZTogUHVibGljIGRvbWFpbi4gQXR0cmlidXRpb24gYXBwcmVjaWF0ZWQuIFRoZSBvcmlnaW5hbCBjeXJiNTMgaGFzIGFcbiAqIHNsaWdodCBtaXhpbmcgYmlhcyBpbiB0aGUgbG93IGJpdHMgb2YgaDEuIFRoaXMgc2hvdWxkbid0IGJlIGEgaHVnZSBwcm9ibGVtLFxuICogYnV0IEkgd2FudCB0byB0cnkgdG8gaW1wcm92ZSBpdC4gVGhpcyBuZXcgdmVyc2lvbiBzaG91bGQgaGF2ZSBpbXByb3ZlZFxuICogYXZhbGFuY2hlIGJlaGF2aW9yLCBidXQgaXQgaXMgbm90IHF1aXRlIGZpbmFsLCBJIG1heSBzdGlsbCBmaW5kIGltcHJvdmVtZW50cy5cbiAqIFNvIGRvbid0IGV4cGVjdCBpdCB0byBhbHdheXMgcHJvZHVjZSB0aGUgc2FtZSBvdXRwdXQuXG4gKi9cblxuLyoqXG4gKiBIYXNoZXMgdGhlIHByb3ZpZGVkIHZhbHVlIHRvIGEgc2hvcnQgc3RyaW5nLiBHZW5lcmFsbHkgdGhpbmdzIHdvbid0IGNvbGxpZGUsXG4gKiBidXQgY29sbGlzaW9ucyBkbyBoYXBwZW4sIHRoYXQncyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIGhhc2hpbmcgYW5kXG4gKiBjb21wcmVzc2lvbi5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhhc2godmFsdWU6IHVua25vd24sIHNlZWQgPSAwKSB7XG4gIGNvbnN0IHN0ciA9XG4gICAgdHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiXG4gICAgICA/IHZhbHVlXG4gICAgICA6IHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIlxuICAgICAgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSlcbiAgICAgIDogYCR7dHlwZW9mIHZhbHVlfSgke1N0cmluZyh2YWx1ZSl9KWBcblxuICBsZXQgaDEgPSAweGRlYWRiZWVmIF4gc2VlZCxcbiAgICBoMiA9IDB4NDFjNmNlNTcgXiBzZWVkXG4gIGZvciAobGV0IGkgPSAwLCBjaDsgaSA8IHN0ci5sZW5ndGg7IGkrKykge1xuICAgIGNoID0gc3RyLmNoYXJDb2RlQXQoaSlcbiAgICBoMSA9IE1hdGguaW11bChoMSBeIGNoLCAweDg1ZWJjYTc3KVxuICAgIGgyID0gTWF0aC5pbXVsKGgyIF4gY2gsIDB4YzJiMmFlM2QpXG4gIH1cbiAgaDEgXj0gTWF0aC5pbXVsKGgxIF4gKGgyID4+PiAxNSksIDB4NzM1YTJkOTcpXG4gIGgyIF49IE1hdGguaW11bChoMiBeIChoMSA+Pj4gMTUpLCAweGNhZjY0OWE5KVxuICBoMSBePSBoMiA+Pj4gMTZcbiAgaDIgXj0gaDEgPj4+IDE2XG5cbiAgY29uc3QgaW50ZWdlciA9IDIwOTcxNTIgKiAoaDIgPj4+IDApICsgKGgxID4+PiAxMSlcblxuICByZXR1cm4gdG9CYXNlNjIoaW50ZWdlcilcbn1cbiIsImltcG9ydCB7IGhhc2ggfSBmcm9tIFwiLi9oZWxwZXJzXCJcblxuZXhwb3J0IHR5cGUgRmlyZXN0b3JlUHJvamVjdFNjaGVtYSA9IHtcbiAgY29sbGVjdGlvbnM6IENvbGxlY3Rpb25TY2hlbWFbXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvamVjdChcbiAgY29sbGVjdGlvbnM6IENvbGxlY3Rpb25TY2hlbWFbXVxuKTogRmlyZXN0b3JlUHJvamVjdFNjaGVtYSB7XG4gIHJldHVybiB7IGNvbGxlY3Rpb25zIH1cbn1cblxuZXhwb3J0IHR5cGUgQ29sbGVjdGlvblNjaGVtYSA9IHtcbiAgcGF0aDogc3RyaW5nXG4gIHJlbGF0aW9uczogUmVjb3JkPHN0cmluZywgUmVsYXRpb24+XG4gIGhhc2g6IHN0cmluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29sbGVjdGlvbihcbiAgcGF0aDogc3RyaW5nLFxuICBmaWVsZHM6IFJlY29yZDxzdHJpbmcsIFJlbGF0aW9uPiA9IHt9XG4pOiBDb2xsZWN0aW9uU2NoZW1hIHtcbiAgY29uc3QgcmVsYXRpb25zOiBSZWNvcmQ8c3RyaW5nLCBSZWxhdGlvbj4gPSB7fVxuXG4gIGZvciAoY29uc3Qga2V5IGluIGZpZWxkcykge1xuICAgIGNvbnN0IHJlbGF0aW9uID0gZmllbGRzW2tleV1cbiAgICByZWxhdGlvbnNba2V5XSA9IHJlbGF0aW9uXG4gIH1cblxuICByZXR1cm4geyBwYXRoLCByZWxhdGlvbnMsIGhhc2g6IGhhc2goeyBwYXRoLCByZWxhdGlvbnMgfSkgfVxufVxuXG5leHBvcnQgdHlwZSBSZWxhdGlvbiA9IHtcbiAgdHlwZTogXCJoYXMtbWFueVwiIHwgXCJoYXMtb25lXCJcbiAgY29sbGVjdGlvbjogQ29sbGVjdGlvblNjaGVtYVxuICBsb2NhbEtleTogc3RyaW5nXG4gIGZvcmVpZ25LZXk6IHN0cmluZ1xufVxuXG50eXBlIFJlbGF0aW9uYXJncyA9IHtcbiAgY29sbGVjdGlvbjogQ29sbGVjdGlvblNjaGVtYSB8IHN0cmluZ1xuICBsb2NhbEtleTogc3RyaW5nXG4gIGZvcmVpZ25LZXk6IHN0cmluZ1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzTWFueShhcmdzOiBSZWxhdGlvbmFyZ3MpOiBSZWxhdGlvbiB7XG4gIHJldHVybiB7XG4gICAgdHlwZTogXCJoYXMtbWFueVwiLFxuICAgIC4uLmFyZ3MsXG4gICAgY29sbGVjdGlvbjpcbiAgICAgIHR5cGVvZiBhcmdzLmNvbGxlY3Rpb24gPT09IFwic3RyaW5nXCJcbiAgICAgICAgPyBjb2xsZWN0aW9uKGFyZ3MuY29sbGVjdGlvbilcbiAgICAgICAgOiBhcmdzLmNvbGxlY3Rpb24sXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc09uZShhcmdzOiBSZWxhdGlvbmFyZ3MpOiBSZWxhdGlvbiB7XG4gIHJldHVybiB7XG4gICAgdHlwZTogXCJoYXMtb25lXCIsXG4gICAgLi4uYXJncyxcbiAgICBjb2xsZWN0aW9uOlxuICAgICAgdHlwZW9mIGFyZ3MuY29sbGVjdGlvbiA9PT0gXCJzdHJpbmdcIlxuICAgICAgICA/IGNvbGxlY3Rpb24oYXJncy5jb2xsZWN0aW9uKVxuICAgICAgICA6IGFyZ3MuY29sbGVjdGlvbixcbiAgfVxufVxuIiwiaW1wb3J0IHtcbiAgRG9jdW1lbnRTbmFwc2hvdCxcbiAgRmllbGRQYXRoLFxuICBGaWx0ZXIsXG4gIEZpcmVzdG9yZSxcbiAgUXVlcnksXG4gIGdldEZpcmVzdG9yZSxcbn0gZnJvbSBcImZpcmViYXNlLWFkbWluL2ZpcmVzdG9yZVwiXG5pbXBvcnQge1xuICBDb2xsZWN0aW9uU2NoZW1hLFxuICBGaXJlc3RvcmVQcm9qZWN0U2NoZW1hLFxuICBSZWxhdGlvbixcbn0gZnJvbSBcIi4vcmVsYXRpb25zXCJcblxudHlwZSBNaWdyYXRlRGF0YSA9IHtcbiAgY29sbGVjdGlvblBhdGg6IHN0cmluZ1xufVxuXG5pbXBvcnQgeyBvbkNhbGwgfSBmcm9tIFwiZmlyZWJhc2UtZnVuY3Rpb25zL3YyL2h0dHBzXCJcbmltcG9ydCB7IGhhc2ggfSBmcm9tIFwiLi9oZWxwZXJzXCJcblxuY29uc29sZS5sb2coXCJnZmYgdjFcIilcblxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpcmViYXNlRnVuY3Rpb25zKFxuICBzY2hlbWE6IEZpcmVzdG9yZVByb2plY3RTY2hlbWFcbikge1xuICByZXR1cm4ge1xuICAgIG1pZ3JhdGU6IG9uQ2FsbDxNaWdyYXRlRGF0YT4oXG4gICAgICB7IHRpbWVvdXRTZWNvbmRzOiA1NDAgfSxcbiAgICAgIGFzeW5jIChyZXF1ZXN0KSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidjFcIilcbiAgICAgICAgY29uc3QgeyBjb2xsZWN0aW9uUGF0aCB9ID0gcmVxdWVzdC5kYXRhXG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb25TY2hlbWEgPSBzY2hlbWEuY29sbGVjdGlvbnMuZmluZChcbiAgICAgICAgICAoeyBwYXRoIH0pID0+IHBhdGggPT09IGNvbGxlY3Rpb25QYXRoXG4gICAgICAgIClcblxuICAgICAgICBpZiAoIWNvbGxlY3Rpb25TY2hlbWEpIHtcbiAgICAgICAgICBjb25zdCBwYXRocyA9IHNjaGVtYS5jb2xsZWN0aW9ucy5tYXAoXG4gICAgICAgICAgICAoeyBwYXRoIH0pID0+IHBhdGhcbiAgICAgICAgICApXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYE5vIHNjaGVtYSBmb3VuZCBmb3IgY29sbGVjdGlvbiB3aXRoIHBhdGggJHtjb2xsZWN0aW9uUGF0aH0uIFNjaGVtYXMgZm91bmQgZm9yICR7cGF0aHMuam9pbihcbiAgICAgICAgICAgICAgXCIsXCJcbiAgICAgICAgICAgICl9YFxuICAgICAgICAgIClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNjaGVtYUhhc2ggPSBoYXNoKGNvbGxlY3Rpb25TY2hlbWEpXG4gICAgICAgIGNvbnN0IHsgcGF0aCwgcmVsYXRpb25zIH0gPSBjb2xsZWN0aW9uU2NoZW1hXG4gICAgICAgIGNvbnN0IHJlbGF0aW9uRW50cmllcyA9IE9iamVjdC5lbnRyaWVzKHJlbGF0aW9ucylcblxuICAgICAgICBjb25zdCBxdWVyeVNuYXBzaG90ID0gYXdhaXQgZ2V0RmlyZXN0b3JlKClcbiAgICAgICAgICAuY29sbGVjdGlvbihwYXRoKVxuICAgICAgICAgIC5nZXQoKVxuXG4gICAgICAgIGZvciAoY29uc3QgZG9jU25hcHNob3Qgb2YgcXVlcnlTbmFwc2hvdC5kb2NzKSB7XG4gICAgICAgICAgY29uc3QgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcbiAgICAgICAgICAgIGlkOiBkb2NTbmFwc2hvdC5pZCxcbiAgICAgICAgICAgIC4uLmRvY1NuYXBzaG90LmRhdGEoKSxcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBkb2N1bWVudFNjaGVtYUhhc2ggPVxuICAgICAgICAgICAgZGF0YVtcIl9fZmlyZXN0b3JlUmVsYXRpb25hbFNjaGVtYUhhc2hcIl1cblxuICAgICAgICAgIGlmIChkb2N1bWVudFNjaGVtYUhhc2ggPT09IHNjaGVtYUhhc2gpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic2tpcHBpbmdcIiwgZGF0YSlcbiAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICBcImRvY1wiLFxuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIFwiZG9lcyBub3QgaGF2ZSBjdXJyZW50IGhhc2hcIixcbiAgICAgICAgICAgIHNjaGVtYUhhc2hcbiAgICAgICAgICApXG5cbiAgICAgICAgICBjb25zdCByZWxhdGlvbkRhdGEgPSBhd2FpdCBnZXRSZWxhdGlvbkRhdGEoXG4gICAgICAgICAgICBgJHtjb2xsZWN0aW9uUGF0aH0vJHtkb2NTbmFwc2hvdC5pZH1gLFxuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIHJlbGF0aW9uRW50cmllcyxcbiAgICAgICAgICAgIHNjaGVtYVxuICAgICAgICAgIClcblxuICAgICAgICAgIGNvbnN0IGpzb25CZWZvcmUgPSBKU09OLnN0cmluZ2lmeShkYXRhKVxuICAgICAgICAgIGNvbnN0IGpzb25BZnRlciA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIC4uLmRhdGEsXG4gICAgICAgICAgICAuLi5yZWxhdGlvbkRhdGEsXG4gICAgICAgICAgfSlcbiAgICAgICAgICBjb25zdCBqc29uUmVsYXRpb25hbCA9IEpTT04uc3RyaW5naWZ5KHJlbGF0aW9uRGF0YSlcblxuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIGpzb25BZnRlciA9PT0ganNvbkJlZm9yZSB8fFxuICAgICAgICAgICAganNvblJlbGF0aW9uYWwgPT09IFwie31cIlxuICAgICAgICAgICkge1xuICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zb2xlLmxvZyhcImRpZmYhXCIsIHtcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICByZWxhdGlvbkRhdGEsXG4gICAgICAgICAgICBqc29uUmVsYXRpb25hbCxcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgYXdhaXQgZ2V0RmlyZXN0b3JlKClcbiAgICAgICAgICAgIC5kb2MoYCR7Y29sbGVjdGlvblBhdGh9LyR7ZG9jU25hcHNob3QuaWR9YClcbiAgICAgICAgICAgIC51cGRhdGUocmVsYXRpb25EYXRhKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWVzc2FnZTogXCJUaGlzIGlzIHdoZXJlIHdlIHdvdWxkIG1pZ3JhdGVcIixcbiAgICAgICAgICBjb2xsZWN0aW9uUGF0aCxcbiAgICAgICAgfVxuICAgICAgfVxuICAgICksXG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UmVsYXRpb25EYXRhKFxuICBkb2N1bWVudFBhdGg6IHN0cmluZyxcbiAgZGF0YTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIHJlbGF0aW9uczogW3N0cmluZywgUmVsYXRpb25dW10sXG4gIHNjaGVtYTogRmlyZXN0b3JlUHJvamVjdFNjaGVtYVxuKSB7XG4gIGNvbnN0IHJlbGF0aW9uRGF0YTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7fVxuXG4gIGZvciAoY29uc3QgW1xuICAgIHJlbGF0aW9uS2V5LFxuICAgIHsgdHlwZSwgbG9jYWxLZXksIGZvcmVpZ25LZXksIGNvbGxlY3Rpb24gfSxcbiAgXSBvZiByZWxhdGlvbnMpIHtcbiAgICBjb25zdCBsb2NhbFZhbHVlID0gZGF0YVtsb2NhbEtleV1cbiAgICBpZiAobG9jYWxWYWx1ZSA9PSBudWxsKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBUcmllZCB0byBzZXQgdXAgcmVsYXRpb24gYmV0d2VlbiBkb2N1bWVudCAke2RvY3VtZW50UGF0aH0gYW5kICR7Y29sbGVjdGlvbi5wYXRofSBidXQgdGhlICR7bG9jYWxLZXl9IGZpZWxkIHdhcyBub3QgZGVmaW5lZC5gXG4gICAgICApXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGNvbnN0IHF1ZXJ5U25hcHNob3QgPSBhd2FpdCBnZXRGaXJlc3RvcmUoKVxuICAgICAgLmNvbGxlY3Rpb24oY29sbGVjdGlvbi5wYXRoKVxuICAgICAgLndoZXJlKFxuICAgICAgICBmb3JlaWduS2V5ID09PSBcImlkXCJcbiAgICAgICAgICA/IEZpZWxkUGF0aC5kb2N1bWVudElkKClcbiAgICAgICAgICA6IGZvcmVpZ25LZXksXG4gICAgICAgIFwiPT1cIixcbiAgICAgICAgbG9jYWxWYWx1ZVxuICAgICAgKVxuICAgICAgLmdldCgpXG5cbiAgICBpZiAodHlwZSA9PT0gXCJoYXMtbWFueVwiKSB7XG4gICAgICBjb25zdCBkb2NzOiB1bmtub3duW10gPSBbXVxuXG4gICAgICBmb3IgKGNvbnN0IGRvY1NuYXBzaG90IG9mIHF1ZXJ5U25hcHNob3QuZG9jcykge1xuICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCBnZXREb2NXaXRoUmVsYXRpb25EYXRhKFxuICAgICAgICAgIGRvY1NuYXBzaG90LFxuICAgICAgICAgIGNvbGxlY3Rpb24sXG4gICAgICAgICAgc2NoZW1hXG4gICAgICAgIClcblxuICAgICAgICBkb2NzLnB1c2goZG9jKVxuICAgICAgfVxuICAgICAgcmVsYXRpb25EYXRhW3JlbGF0aW9uS2V5XSA9IGRvY3NcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFwiaGFzLW9uZVwiKSB7XG4gICAgICBjb25zdCBbZG9jU25hcHNob3RdID0gcXVlcnlTbmFwc2hvdC5kb2NzXG5cbiAgICAgIGlmICghZG9jU25hcHNob3QpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGBUcmllZCB0byBzZXQgdXAgcmVsYXRpb24gYmV0d2VlbiBkb2N1bWVudCAke2RvY3VtZW50UGF0aH0gYW5kICR7XG4gICAgICAgICAgICBjb2xsZWN0aW9uLnBhdGhcbiAgICAgICAgICB9IGJ1dCB0aGVyZSBhcmUgbm8gZG9jdW1lbnRzIHdpdGggJHtmb3JlaWduS2V5fSA9PSAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgbG9jYWxWYWx1ZVxuICAgICAgICAgICl9YFxuICAgICAgICApXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG5cbiAgICAgIHJlbGF0aW9uRGF0YVtyZWxhdGlvbktleV0gPSBhd2FpdCBnZXREb2NXaXRoUmVsYXRpb25EYXRhKFxuICAgICAgICBkb2NTbmFwc2hvdCxcbiAgICAgICAgY29sbGVjdGlvbixcbiAgICAgICAgc2NoZW1hXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlbGF0aW9uRGF0YVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREb2NXaXRoUmVsYXRpb25EYXRhKFxuICBkb2NTbmFwc2hvdDogRG9jdW1lbnRTbmFwc2hvdCxcbiAgY29sbGVjdGlvbjogQ29sbGVjdGlvblNjaGVtYSxcbiAgc2NoZW1hOiBGaXJlc3RvcmVQcm9qZWN0U2NoZW1hXG4pIHtcbiAgY29uc3QgZG9jSGFzUmVsYXRpb25zID1cbiAgICBPYmplY3Qua2V5cyhjb2xsZWN0aW9uLnJlbGF0aW9ucykubGVuZ3RoID4gMFxuXG4gIGNvbnN0IGRhdGEgPSB7XG4gICAgaWQ6IGRvY1NuYXBzaG90LmlkLFxuICAgIC4uLmRvY1NuYXBzaG90LmRhdGEoKSxcbiAgfVxuXG4gIGlmICghZG9jSGFzUmVsYXRpb25zKSB7XG4gICAgcmV0dXJuIGRhdGFcbiAgfVxuXG4gIGNvbnN0IGRvY1JlbGF0aW9uRGF0YSA9IGF3YWl0IGdldFJlbGF0aW9uRGF0YShcbiAgICBgJHtjb2xsZWN0aW9uLnBhdGh9LyR7ZG9jU25hcHNob3QuaWR9YCxcbiAgICBkYXRhLFxuICAgIE9iamVjdC5lbnRyaWVzKGNvbGxlY3Rpb24ucmVsYXRpb25zKSxcbiAgICBzY2hlbWFcbiAgKVxuXG4gIE9iamVjdC5hc3NpZ24oZGF0YSwgZG9jUmVsYXRpb25EYXRhKVxuXG4gIHJldHVybiBkYXRhXG59XG4iXSwibmFtZXMiOlsiQ0hBUlNFVCIsInRvQmFzZTYyIiwiaW50ZWdlciIsImNoYXJzIiwiaGFzaCIsInZhbHVlIiwic2VlZCIsInN0ciIsImgxIiwiaDIiLCJpIiwiY2giLCJwcm9qZWN0IiwiY29sbGVjdGlvbnMiLCJjb2xsZWN0aW9uIiwicGF0aCIsImZpZWxkcyIsInJlbGF0aW9ucyIsImtleSIsInJlbGF0aW9uIiwiaGFzTWFueSIsImFyZ3MiLCJoYXNPbmUiLCJnZXRGaXJlYmFzZUZ1bmN0aW9ucyIsInNjaGVtYSIsIm9uQ2FsbCIsInJlcXVlc3QiLCJjb2xsZWN0aW9uUGF0aCIsImNvbGxlY3Rpb25TY2hlbWEiLCJwYXRocyIsInNjaGVtYUhhc2giLCJyZWxhdGlvbkVudHJpZXMiLCJxdWVyeVNuYXBzaG90IiwiZ2V0RmlyZXN0b3JlIiwiZG9jU25hcHNob3QiLCJkYXRhIiwicmVsYXRpb25EYXRhIiwiZ2V0UmVsYXRpb25EYXRhIiwianNvbkJlZm9yZSIsImpzb25BZnRlciIsImpzb25SZWxhdGlvbmFsIiwiZG9jdW1lbnRQYXRoIiwicmVsYXRpb25LZXkiLCJ0eXBlIiwibG9jYWxLZXkiLCJmb3JlaWduS2V5IiwibG9jYWxWYWx1ZSIsIkZpZWxkUGF0aCIsImRvY3MiLCJkb2MiLCJnZXREb2NXaXRoUmVsYXRpb25EYXRhIiwiZG9jSGFzUmVsYXRpb25zIiwiZG9jUmVsYXRpb25EYXRhIl0sIm1hcHBpbmdzIjoidWFBQUEsTUFBTUEsRUFDSixpRUFBaUUsTUFDL0QsRUFDRixFQUVLLFNBQVNDLEVBQVNDLEVBQWlCLENBQ3hDLEdBQUlBLElBQVksRUFDUCxNQUFBLElBR1QsTUFBTUMsRUFBUSxDQUFBLEVBQ2QsS0FBT0QsRUFBVSxHQUNmQyxFQUFNLEtBQUtILEVBQVFFLEVBQVUsRUFBRSxDQUFDLEVBQ3RCQSxFQUFBLEtBQUssTUFBTUEsRUFBVSxFQUFFLEVBRzVCLE9BQUFDLEVBQU0sS0FBSyxFQUFFLENBQ3RCLENDR2dCLFNBQUFDLEVBQUtDLEVBQWdCQyxFQUFPLEVBQUcsQ0FDN0MsTUFBTUMsRUFDSixPQUFPRixHQUFVLFNBQ2JBLEVBQ0EsT0FBT0EsR0FBVSxTQUNqQixLQUFLLFVBQVVBLENBQUssRUFDcEIsR0FBRyxPQUFPQSxLQUFTLE9BQU9BLENBQUssS0FFckMsSUFBSUcsRUFBSyxXQUFhRixFQUNwQkcsRUFBSyxXQUFhSCxFQUNwQixRQUFTSSxFQUFJLEVBQUdDLEVBQUlELEVBQUlILEVBQUksT0FBUUcsSUFDN0JDLEVBQUFKLEVBQUksV0FBV0csQ0FBQyxFQUNyQkYsRUFBSyxLQUFLLEtBQUtBLEVBQUtHLEVBQUksVUFBVSxFQUNsQ0YsRUFBSyxLQUFLLEtBQUtBLEVBQUtFLEVBQUksVUFBVSxFQUVwQ0gsR0FBTSxLQUFLLEtBQUtBLEVBQU1DLElBQU8sR0FBSyxVQUFVLEVBQzVDQSxHQUFNLEtBQUssS0FBS0EsRUFBTUQsSUFBTyxHQUFLLFVBQVUs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
